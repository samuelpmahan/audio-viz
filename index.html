<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan Audio Engine</title>
    
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "meyda": "https://esm.sh/meyda@5.6.3"
        }
      }
    </script>

    <style>
        body { 
            background: #000; 
            color: #fff; 
            font-family: 'Courier New', Courier, monospace; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* -- CANVAS -- */
        #viz-canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
            /* Ensure clicks pass through to canvas if needed, but UI needs them */
        }

        /* -- START OVERLAY -- */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8);
            z-index: 20;
            transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 40px;
            font-size: 24px;
            background: transparent;
            color: #00e5ff;
            border: 2px solid #00e5ff;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
            transition: all 0.2s;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #start-btn:hover { 
            background: #00e5ff; 
            color: #000; 
            box-shadow: 0 0 40px #00e5ff; 
        }

        /* -- GHOST DASHBOARD -- */
        #bottom-dashboard {
            position: absolute;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            
            /* Glassmorphism look */
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            
            padding: 15px 25px;
            box-sizing: border-box;
            z-index: 10;
            
            /* Layout: Switcher | Specific Controls | Gain */
            display: none; /* Hidden until started */
            grid-template-columns: 250px 1fr 150px; 
            gap: 30px;
            align-items: center;

            /* GHOST MODE TRANSITIONS */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* When active class is added via JS, show it */
        #bottom-dashboard.visible {
            opacity: 1;
        }

        /* 1. VIZ SWITCHER (Grid for compactness) */
        #viz-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .viz-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            padding: 6px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 4px;
            text-align: center;
        }
        .viz-btn:hover { border-color: #fff; color: #fff; background: rgba(255, 255, 255, 0.1); }
        .viz-btn.active {
            background: #00e5ff;
            color: #000;
            border-color: #00e5ff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
        }

        /* 2. SPECIFIC CONTROLS (The Scrollable Middle) */
        #specific-controls {
            display: flex;
            flex-wrap: nowrap; /* Horizontal scroll */
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 5px; /* Space for scrollbar */
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding-left: 20px;
            padding-right: 20px;
        }
        
        /* Custom Scrollbar */
        #specific-controls::-webkit-scrollbar { height: 4px; }
        #specific-controls::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        #specific-controls::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 100px;
        }
        
        .control-group label {
            font-size: 10px;
            color: #00e5ff;
            margin-bottom: 6px;
            white-space: nowrap;
            letter-spacing: 1px;
        }
        
        input[type=range] {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff;
            margin-top: -4px; /* Align vertical */
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        /* 3. GAIN (Right Side) */
        #gain-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .ctrl-label { font-size: 10px; color: #888; margin-bottom: 8px; text-align: right; }

    </style>
</head>
<body>

    <canvas id="viz-canvas"></canvas>

    <div id="start-overlay">
        <button id="start-btn">INITIALIZE SYSTEM</button>
    </div>

    <div id="bottom-dashboard">
        
        <div id="viz-switcher"></div>

        <div id="specific-controls">
            <span style="color:#444; font-size:10px;">NO MANUAL CONTROLS</span>
        </div>

        <div id="gain-area">
            <div class="ctrl-label">SENSITIVITY: <span id="gainVal">2.5</span></div>
            <input type="range" id="gainSlider" min="0" max="10" step="0.1" value="2.5">
        </div>

    </div>

    <script type="module">
        import { AudioAnalyzer } from './audio-engine-v7.js';
        
        // Import Visualizers
        import { ParticleTunnel } from './vortex-viz.js';
        import { JoyViz } from './joy-viz.js';
        import { ConstellationViz } from './constellation-viz.js';
        import { CrystalViz } from './crystal-viz.js';
        import { CrystalViz2 } from './crystal2-viz.js';
        import { ParticleTunnel2 } from './vortex2-viz.js';
        import { Landslide } from './landslide-viz.js';
        import { HotelCalifornia } from './deserthighway-viz.js'
        import { LiquidMetal } from './liquid-viz.js';
        import { PulseGrid } from './pulse-grid-viz.js';
        import { PlasmaTunnel } from './plasma-tunnel-viz.js';
        import { Tesseract } from './tesseract-viz.js';
        import { CoralReef } from './coral-reef-viz.js';

        // --- CONFIGURATION MAP ---
        const VISUALIZERS = new Map([
            ['Vortex', ParticleTunnel],
            ['Joy Division', JoyViz],
            ['Constellation', ConstellationViz],
            ['Crystal Core', CrystalViz],
            ['Plasma', CrystalViz2],
            ['Vortex2', ParticleTunnel2],
            ['Landslide', Landslide],
            ['Desert Highway', HotelCalifornia],
            ['Liquid Metal', LiquidMetal],
            ['Pulse Grid', PulseGrid],
            ['PlasmaTunnel', PlasmaTunnel],
            ['Tesseract', Tesseract],
            ['CoralReef', CoralReef]
        ]);

        const engine = new AudioAnalyzer();
        let currentViz = null;

        // UI Elements
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const dashboard = document.getElementById('bottom-dashboard');
        const switcher = document.getElementById('viz-switcher');
        const specificContainer = document.getElementById('specific-controls');
        
        // --- AUTO-HIDE / GHOST UI LOGIC ---
        let idleTimer = null;

        function showUI() {
            dashboard.classList.add('visible');
            // Reset timer
            if (idleTimer) clearTimeout(idleTimer);
            // Hide after 3 seconds of inactivity
            idleTimer = setTimeout(() => {
                dashboard.classList.remove('visible');
            }, 3000);
        }

        // Listen for mouse movement anywhere on screen
        document.addEventListener('mousemove', showUI);
        document.addEventListener('click', showUI);
        document.addEventListener('touchstart', showUI);

        // --- RENDER DYNAMIC CONTROLS ---
        function renderVizControls(vizInstance) {
            specificContainer.innerHTML = ''; // Clear previous controls
            
            if (vizInstance && typeof vizInstance.getParams === 'function') {
                const params = vizInstance.getParams();
                
                params.forEach(p => {
                    const group = document.createElement('div');
                    group.className = 'control-group';
                    
                    const label = document.createElement('label');
                    label.innerText = `${p.name}: ${p.value}`;
                    
                    const input = document.createElement('input');
                    input.type = 'range';
                    input.min = p.min;
                    input.max = p.max;
                    input.step = p.step;
                    input.value = p.value;
                    
                    input.addEventListener('input', (e) => {
                        const val = parseFloat(e.target.value);
                        label.innerText = `${p.name}: ${val}`;
                        p.onChange(val);
                        showUI(); // Keep UI alive while dragging
                    });
                    
                    group.appendChild(label);
                    group.appendChild(input);
                    specificContainer.appendChild(group);
                });
            } else {
                specificContainer.innerHTML = '<span style="color:#444; font-size:10px; align-self:center;">NO MANUAL CONTROLS</span>';
            }
        }

        // --- SWITCHER UI ---
        function renderSwitcher() {
            switcher.innerHTML = '';
            let isFirst = true;

            VISUALIZERS.forEach((VizClass, name) => {
                const btn = document.createElement('button');
                btn.className = 'viz-btn';
                btn.innerText = name;
                
                if (isFirst) {
                    btn.classList.add('active');
                    isFirst = false;
                }

                btn.addEventListener('click', () => {
                    switchViz(name, btn);
                    showUI();
                });
                switcher.appendChild(btn);
            });
        }

        function switchViz(name, btnElement) {
            document.querySelectorAll('.viz-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            const VizClass = VISUALIZERS.get(name);
            if (!VizClass) return;

            console.log(`Switching to: ${name}`);

            try {
                // Cleanup (Simple renderer dispose for now)
                if (currentViz && currentViz.renderer) {
                    // Optional: currentViz.renderer.dispose();
                    // In a perfect world we would call currentViz.dispose() to clean up geometries
                }
                
                currentViz = new VizClass();
                
                // GENERATE THE CONTROLS FOR THIS NEW VIZ
                renderVizControls(currentViz);

            } catch (err) {
                console.error("Viz Load Error:", err);
            }
        }

        // --- INITIALIZATION ---
        startBtn.addEventListener('click', async () => {
            await engine.init();
            
            startOverlay.style.opacity = '0';
            setTimeout(() => startOverlay.style.display = 'none', 500);
            
            dashboard.style.display = 'grid'; // Enable grid layout
            setTimeout(showUI, 100); // Trigger fade-in

            renderSwitcher();
            
            // Auto-load first viz
            const firstKey = VISUALIZERS.keys().next().value;
            const firstBtn = switcher.querySelector('.viz-btn');
            switchViz(firstKey, firstBtn);

            loop();
        });

        document.getElementById('gainSlider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            engine.setGain(val);
            document.getElementById('gainVal').innerText = val;
            showUI();
        });

        function loop() {
            requestAnimationFrame(loop);
            engine.update();
            
            const m = engine.getMetrics();
            const raw = engine.getRawData();

            // Render Viz
            if (currentViz) currentViz.animate(m, raw);
        }
    </script>
</body>
</html>