<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan Audio Engine</title>
    
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <style>
        body { 
            background: #000; 
            color: #0f0; 
            font-family: monospace; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* -- VISUALIZER CANVAS -- */
        #viz-canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* -- DASHBOARD LAYER -- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85);
            z-index: 10;
            transition: opacity 0.5s;
            opacity: 1;
            pointer-events: auto;
        }

        /* THE FIX: High Specificity & !important to force hiding */
        #ui-layer.hidden { 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }

        #dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 600px; opacity: 0.8; }
        .meter-container { background: #333; padding: 10px; border-radius: 4px; }
        .label { margin-bottom: 5px; font-weight: bold; color: #fff; }
        .bar-bg { width: 100%; height: 20px; background: #000; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.05s linear; }

        #bass-fill { background: #ff0055; } 
        #mid-fill { background: #ffdd00; }  
        #treble-fill { background: #00e5ff; } 
        #wub-fill { background: #a020f0; }
        
        #beat-indicator {
            width: 80px; height: 80px; background: #222; border-radius: 50%;
            border: 2px solid #555;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: white; margin: 10px;
        }
        
        .beat-row { display: flex; justify-content: center; margin-top: 20px; }
        
        .hit { background: #fff !important; box-shadow: 0 0 30px white; color: black !important; }
        .snare-hit { background: #ffdd00 !important; box-shadow: 0 0 30px #ffdd00; color: black !important; }

        button { padding: 15px 30px; font-size: 18px; cursor: pointer; margin-bottom: 20px; background: #0f0; border: none; font-weight: bold;}
        button:hover { background: #fff; }
        
        #switch-btn {
            margin-top: 30px;
            background: transparent;
            border: 2px solid #00e5ff;
            color: #00e5ff;
            display: none; 
        }
        #switch-btn:hover { background: #00e5ff; color: #000; }

    </style>
</head>
<body>

    <canvas id="viz-canvas"></canvas>

    <div id="ui-layer">
        <button id="start-btn">INIT AUDIO ENGINE</button>
        
        <div id="controls" style="display:none; text-align: center;">
            <div style="margin-bottom: 20px;">
                <label for="gainSlider" style="color:white; font-weight:bold;">INPUT GAIN: </label>
                <input type="range" id="gainSlider" min="0" max="10" step="0.1" value="2.5">
                <span id="gainVal" style="color:white;">2.5</span>
            </div>
            
            <div id="dashboard">
                <div class="meter-container"><div class="label">SUB BASS</div><div class="bar-bg"><div id="bass-fill" class="bar-fill"></div></div></div>
                <div class="meter-container"><div class="label">MIDS</div><div class="bar-bg"><div id="mid-fill" class="bar-fill"></div></div></div>
                <div class="meter-container"><div class="label">TREBLE</div><div class="bar-bg"><div id="treble-fill" class="bar-fill"></div></div></div>
                <div class="meter-container"><div class="label">WUB (Centroid)</div><div class="bar-bg"><div id="wub-fill" class="bar-fill"></div></div></div>
            </div>

            <div class="beat-row">
                <div id="kick-indicator">KICK</div>
                <div id="snare-indicator">SNARE</div>
            </div>

            <button id="switch-btn">ENTER VORTEX</button>
        </div>
    </div>

    <script type="module">
        import { AudioAnalyzer } from './audio-engine.js';
        import { ParticleTunnel } from './vortex-viz.js';
        import { ParticleTunnel2 } from './vortex2-viz.js';
        import { JoyViz } from './joy-viz.js';
        import { ConstellationViz } from './constellation-viz.js'
        import { CrystalViz } from './crystal-viz.js'
        import { CrystalViz2 } from './crystal2-viz.js'

        const engine = new AudioAnalyzer();
        let currentViz = null;
        let vizIndex = -1; 

        // DOM Elements
        const uiLayer = document.getElementById('ui-layer');
        const startBtn = document.getElementById('start-btn');
        const controls = document.getElementById('controls');
        const switchBtn = document.getElementById('switch-btn');
        
        const elBass = document.getElementById('bass-fill');
        const elMid = document.getElementById('mid-fill');
        const elTreble = document.getElementById('treble-fill');
        const elWub = document.getElementById('wub-fill');
        const elBeat = document.getElementById('beat-indicator');
        const elKick = document.getElementById('kick-indicator');
        const elSnare = document.getElementById('snare-indicator');

        // 1. INIT
        startBtn.addEventListener('click', async () => {
            await engine.init();
            startBtn.style.display = 'none';
            controls.style.display = 'block';
            switchBtn.style.display = 'inline-block';
            
            // Start default viz
            try {
                currentViz = new ParticleTunnel();
            } catch(e) { console.error("Viz Error:", e); }
            
            loop();
        });

        // 2. SWITCH BUTTON
        switchBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Stop click from hitting window

            vizIndex++;
            if (vizIndex > 5) vizIndex = 0;

            try {
                if (vizIndex === 0) {
                    currentViz = new ParticleTunnel();
                    switchBtn.innerText = "SWITCH TO JOY DIVISION";
                } else if (vizIndex === 1) {
                    currentViz = new JoyViz();
                    switchBtn.innerText = "SWITCH TO CONSTELLATION";
                } else if (vizIndex === 2) {
                    currentViz = new ConstellationViz();
                    switchBtn.innerText = "SWITCH TO CRYSTAL";
                } else if (vizIndex === 3) {
                    currentViz = new CrystalViz();
                    switchBtn.innerText = "SWITCH TO CRYSTAL2";
                } else if (vizIndex === 4) {
                    currentViz = new CrystalViz2();
                    switchBtn.innerText = "SWITCH TO VORTEX2";
                } else {
                    currentViz = new ParticleTunnel2();
                    switchBtn.innerText = "SWITCH TO VORTEX";
                }
                
                // HIDE UI
                uiLayer.classList.add('hidden');
                
            } catch(err) {
                console.error("Error switching visualizer:", err);
                alert("Visualizer failed to load. Check console.");
            }
        });

        // 3. SHOW UI (Click anywhere else)
        window.addEventListener('click', (e) => {
            // If we clicked an input or button, don't show UI
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            
            uiLayer.classList.remove('hidden');
        });

        // GAIN
        document.getElementById('gainSlider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            engine.setGain(val);
            document.getElementById('gainVal').innerText = val;
        });

        function loop() {
            requestAnimationFrame(loop);
            engine.update();
            const m = engine.getMetrics();
            const raw = engine.getRawData();

            // UI
            elBass.style.width = `${m.bass * 100}%`;
            elMid.style.width = `${m.mid * 100}%`;
            elTreble.style.width = `${m.treble * 100}%`;
            elWub.style.width = `${m.centroid * 100}%`;
            if (m.isKick) elKick.classList.add('hit');
            else elKick.classList.remove('hit');

            // SNARE VIZ
            if (m.isSnare) elSnare.classList.add('snare-hit');
            else elSnare.classList.remove('snare-hit');

            // VIZ
            if (currentViz) currentViz.animate(m, raw);
        }
    </script>
</body>
</html>