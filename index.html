<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Titan Audio Engine</title>
    
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "meyda": "https://esm.sh/meyda@5.6.0"
        }
      }
    </script>

    <style>
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', Courier, monospace; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* -- CANVAS -- */
        #viz-canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* -- START OVERLAY -- */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 20;
            transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 40px;
            font-size: 24px;
            background: #00e5ff;
            color: #000;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 20px #00e5ff;
            transition: all 0.2s;
        }
        #start-btn:hover { background: #fff; box-shadow: 0 0 40px #fff; }

        /* -- DASHBOARD (Bottom Dock) -- */
        #bottom-dashboard {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #000 0%, rgba(0,0,0,0.9) 100%);
            border-top: 1px solid #333;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 10;
            display: none; /* Hidden until started */
            grid-template-columns: 300px 1fr 200px 80px; /* Switcher | Meters | Gain | Beats */
            gap: 20px;
            align-items: center;
        }

        /* 1. VIZ SWITCHER */
        #viz-switcher {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .viz-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.2s;
        }
        .viz-btn:hover { border-color: #fff; color: #fff; }
        .viz-btn.active {
            background: #00e5ff;
            color: #000;
            border-color: #00e5ff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        /* 2. METERS */
        #meters-area {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }
        .meter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
            color: #aaa;
        }
        .bar-bg {
            flex-grow: 1;
            height: 8px;
            background: #222;
            border-radius: 2px;
            overflow: hidden;
        }
        .bar-fill { height: 100%; width: 0%; transition: width 0.05s linear; }
        #bass-fill { background: #ff0055; }
        #mid-fill { background: #ffdd00; }
        #treble-fill { background: #00e5ff; }
        #wub-fill { background: #a020f0; }

        /* 3. GAIN */
        #gain-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[type=range] { width: 100%; cursor: pointer; }
        .ctrl-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }

        /* 4. BEAT INDICATORS (UPDATED) */
        #beat-area {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
        .beat-light {
            width: 80px; height: 25px;
            background: #111;
            border: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #444;
            font-weight: bold;
            border-radius: 4px;
            transition: background 0.05s, transform 0.05s, box-shadow 0.05s;
        }
        /* KICK STATE (White) */
        #kick-indicator.hit {
            background: #fff;
            color: #000;
            box-shadow: 0 0 15px #fff;
            border-color: #fff;
            transform: scale(1.05);
        }
        /* SNARE STATE (Gold) */
        #snare-indicator.hit {
            background: #ffdd00;
            color: #000;
            box-shadow: 0 0 15px #ffdd00;
            border-color: #ffdd00;
            transform: scale(1.05);
        }

    </style>
</head>
<body>

    <canvas id="viz-canvas"></canvas>

    <div id="start-overlay">
        <button id="start-btn">INITIALIZE SYSTEM</button>
    </div>

    <div id="bottom-dashboard">
        
        <div id="viz-switcher">
            </div>

        <div id="meters-area">
            <div class="meter-row">
                <span style="width:40px">BASS</span>
                <div class="bar-bg"><div id="bass-fill" class="bar-fill"></div></div>
            </div>
            <div class="meter-row">
                <span style="width:40px">MID</span>
                <div class="bar-bg"><div id="mid-fill" class="bar-fill"></div></div>
            </div>
            <div class="meter-row">
                <span style="width:40px">HIGH</span>
                <div class="bar-bg"><div id="treble-fill" class="bar-fill"></div></div>
            </div>
            <div class="meter-row">
                <span style="width:40px">WUB</span>
                <div class="bar-bg"><div id="wub-fill" class="bar-fill"></div></div>
            </div>
        </div>

        <div id="gain-area">
            <div class="ctrl-label">INPUT GAIN: <span id="gainVal">2.5</span></div>
            <input type="range" id="gainSlider" min="0" max="10" step="0.1" value="2.5">
        </div>

        <div id="beat-area">
            <div id="kick-indicator" class="beat-light">KICK</div>
            <div id="snare-indicator" class="beat-light">SNARE</div>
        </div>
    </div>

    <script type="module">
        import { AudioAnalyzer } from './audio-engine.js';
        
        // Import Visualizers
        import { ParticleTunnel } from './vortex-viz.js';
        import { JoyViz } from './joy-viz.js';
        import { ConstellationViz } from './constellation-viz.js';
        import { CrystalViz } from './crystal-viz.js';
        import { CrystalViz2 } from './crystal2-viz.js';
        import { ParticleTunnel2 } from './vortex2-viz.js';
        import { Landslide } from './landslide-viz.js';
        import { HotelCalifornia } from './deserthighway-viz.js'

        // --- CONFIGURATION MAP ---
        // Add new visualizers here. Key = Name, Value = Class
        const VISUALIZERS = new Map([
            ['Vortex', ParticleTunnel],
            ['Joy Division', JoyViz],
            ['Constellation', ConstellationViz],
            ['Crystal Core', CrystalViz],
            ['Plasma', CrystalViz2],
            ['Vortex2', ParticleTunnel2],
            ['Landslide', Landslide],
            ['DesertHighway', HotelCalifornia]
        ]);

        const engine = new AudioAnalyzer();
        let currentViz = null;

        // UI Elements
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const dashboard = document.getElementById('bottom-dashboard');
        const switcher = document.getElementById('viz-switcher');
        
        const elBass = document.getElementById('bass-fill');
        const elMid = document.getElementById('mid-fill');
        const elTreble = document.getElementById('treble-fill');
        const elWub = document.getElementById('wub-fill');
        
        // NEW ELEMENTS
        const elKick = document.getElementById('kick-indicator');
        const elSnare = document.getElementById('snare-indicator');

        // 1. GENERATE SWITCHER UI
        function renderSwitcher() {
            switcher.innerHTML = '';
            let isFirst = true;

            VISUALIZERS.forEach((VizClass, name) => {
                const btn = document.createElement('button');
                btn.className = 'viz-btn';
                btn.innerText = name;
                
                if (isFirst) {
                    btn.classList.add('active');
                    isFirst = false;
                }

                btn.addEventListener('click', () => switchViz(name, btn));
                switcher.appendChild(btn);
            });
        }

        // 2. SWITCH LOGIC
        function switchViz(name, btnElement) {
            // Update Active State
            document.querySelectorAll('.viz-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            const VizClass = VISUALIZERS.get(name);
            if (!VizClass) return;

            console.log(`Switching to: ${name}`);

            try {
                // Note: Ideally we should .dispose() the old viz here if methods existed
                // to prevent memory leaks (event listeners, geometries, etc).
                currentViz = new VizClass();
            } catch (err) {
                console.error("Viz Load Error:", err);
            }
        }

        // 3. START SEQUENCE
        startBtn.addEventListener('click', async () => {
            await engine.init();
            
            // UI Transition
            startOverlay.style.opacity = '0';
            setTimeout(() => startOverlay.style.display = 'none', 500);
            dashboard.style.display = 'grid'; // Show Dashboard

            // Init Default Viz (First in Map)
            renderSwitcher();
            const firstKey = VISUALIZERS.keys().next().value;
            const firstBtn = switcher.querySelector('.viz-btn'); // Get first generated button
            switchViz(firstKey, firstBtn);

            loop();
        });

        // 4. GAIN CONTROL
        document.getElementById('gainSlider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            engine.setGain(val);
            document.getElementById('gainVal').innerText = val;
        });

        // 5. ANIMATION LOOP
        function loop() {
            requestAnimationFrame(loop);
            engine.update();
            
            const m = engine.getMetrics();
            const raw = engine.getRawData();

            // Update Meters
            elBass.style.width = `${m.bass * 100}%`;
            elMid.style.width = `${m.mid * 100}%`;
            elTreble.style.width = `${m.treble * 100}%`;
            elWub.style.width = `${m.centroid * 100}%`;
            
            // UPDATED: Kick Flash
            if (m.isKick) elKick.classList.add('hit'); 
            else elKick.classList.remove('hit');

            // UPDATED: Snare Flash
            if (m.isSnare) elSnare.classList.add('hit');
            else elSnare.classList.remove('hit');

            // Render Viz
            if (currentViz) currentViz.animate(m, raw);
        }
    </script>
</body>
</html>